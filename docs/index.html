<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="shortcut icon" href="./111.jpg">
</head>
<body>
昵称：<span></span>
</body>

<script type="text/javascript">
    const hasUserInfo = (authorize)=>{
        alert(JSON.stringify(authorize))
    };
    const wxAuthorize = (callback) => {
        const appID = "wx9348d50780020d94",
            appsecret = "1492488b47bb6b0af6ee415efb49bd33",
            // url = `${location.protocol}//${location.host}/course/period/live/${this.course}`;
            url = `https://kxtopen-api.9itest.com/frontend/cms/user/wechat/callback`;
        const search = location.search;
        const code = search ? search.split("&")[0].split("?code=")[1] : "";
        if(code){
            const token = JSON.parse(localStorage.getItem("wxToken"));
            if(token) {
                //已获取token，获取用户信息
                const userUrl = `/userinfo?access_token=${token.access_token}&openid=${token.openid}&lang=zh_CN`;
                alert("获取用户信息")
            }else{
                //授权成功，换取网页授权access_token
                const tokenUrl = `/oauth2/access_token?appid=${appID}&secret=${appsecret}&code=${code}&grant_type=authorization_code`;
                alert("换取网页授权access_token")
            }
        }else{
            //没有授权
            const wxUserInfo = localStorage.getItem("authorize");
            if(wxUserInfo) {
                //已经授权
                callback();
            } else {
                //授权
                const allowUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appID}&redirect_uri=${encodeURIComponent(url)}&response_type=code&scope=snsapi_userinfo#wechat_redirect`;
                window.location.href = allowUrl;
            }
        }
    };
    const qqAuthorize = (callback) => {
        const appID = "101467260",
            redirect = "https://kxtopen-api.9itest.com/frontend/cms/user/qq/callback";
        const search = location.href;
        const code = search&&search.split("access_token=")[1] ? search.split("access_token=")[1].split("&")[0] : "";
        if(code){
            const token = {access_token: code};
            //授权成功，获取openid
            const tokenUrl = `/oauth2.0/me?access_token=${token.access_token}`;
            alert("获取openid")
        }else{
            //没有授权
            const qqUserInfo = localStorage.getItem("authorize");
            if(qqUserInfo) {
                //已经授权
                callback();
            } else {
                //授权
                const allowUrl = `https://graph.qq.com/oauth2.0/authorize?client_id=${appID}&response_type=token&redirect_uri=${encodeURIComponent(redirect)}`;
                // const allowUrl = `https://localhost:20201/observe/eyJwZXJpb2RJZCI6MjQwM30=?#access_token=279D8CD95BF71487712ABA5A6FBC00A6&expires_in=7776000`;
                window.location.href = allowUrl;
            }
        }
    };

    //TODO 判断浏览器
    const ua = navigator.userAgent.toLowerCase();
    let authorize = JSON.parse(localStorage.getItem("authorize"));
    if(/MicroMessenger/i.test(ua)){
        //微信浏览器
        if(authorize){
            hasUserInfo(authorize);
        }else{
            //TODO 微信授权
            wxAuthorize((res)=>{
                if(res){
                    authorize = {
                        nickName: res.nickname,
                        id: Number(Math.random().toString().substr(3, 8) + Date.now()).toString(36),
                        source: "微信"
                    };
                }
                hasUserInfo(authorize);
            });
        }
    }else if(/QQ/i.test(ua)){
        //QQ浏览器
        if(authorize){
            hasUserInfo(authorize);
        }else{
            //TODO qq授权
            qqAuthorize((res)=>{
                if(res){
                    authorize = {
                        nickName: res.nickname,
                        id: Number(Math.random().toString().substr(3, 8) + Date.now()).toString(36),
                        source: "QQ"
                    };
                }
                hasUserInfo(authorize);
            });
        }
    }else{
        if(authorize){
            hasUserInfo(authorize);
        }else{
            //TODO 浏览器生成唯一id
            authorize = {
                id: Number(Math.random().toString().substr(3, 8) + Date.now()).toString(36),
                source: "浏览器"
            };
            hasUserInfo(authorize);
        }
    }
</script>
</html>